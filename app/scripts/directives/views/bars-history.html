<div class="container-fluid">
    <div class="row">
        <div ng-show="canUpdate" class="col-sm-2">
            <a title="Mettre à jour l'historique" ng-click="update()" class="btn btn-primary" ng-class="updating && 'disabled'">
                <span ng-class="updating && 'glyphicon-refresh-animate'" class="glyphicon glyphicon-refresh"></span> Actualiser
            </a>
        </div>
        <div class="col-sm-offset-5 col-sm-5">
            <input type="search" class="form-control" ng-model="queryh" placeholder="Rechercher dans l'historique" id="queryh" />
        </div>
    </div>
</div>

<br /><br />

<ul>
    <li ng-repeat="h in history | filter:queryh" ng-class="h.canceled && 'del' || ''">
        <ng:switch on="h.type">
            <!-- Cas de la mise à la poubelle -->
            <span ng-switch-when="throw" class="bg-warning">
                {{ h.timestamp | amCalendar }} : mise à la poubelle de
                <span ng-repeat="o in h.operations | filter:'stockoperation'">
                    <span ng-if="$middle">, </span>
                    <span ng-if="$last && !$first"> et de </span>
                    <bars:food food="o.item" qty="(-1)*o.deltaqty"></bars:food>
                </span>
                par <bars:account account="h.author.accounts[0]" user="h.author"></bars:account>
                <a title="Annuler cette transaction" ng-if="!h.canceled" ng-click="cancelTransaction(h)" class="label label-warning">Annuler</a>
            </span>

            <!-- Cas d'un don -->
            <span ng-switch-when="give">
                {{ h.timestamp | amCalendar }} : don de {{ h.moneyflow | currency }} à 
                <span ng-repeat="o in h.operations | filter:'accountoperation'"><span ng-if="o.deltamoney > 0">
                    <bar:account account="o.account"></bar:account>
                </span></span> 
                par <bars:account account="h.author.accounts[0]" user="h.author"></bars:account>
                <a title="Annuler cette transaction" ng-if="!h.canceled" ng-click="cancelTransaction(h)" class="label label-warning">Annuler</a>
            </span>

            <span ng-switch-when="buy">
                <!-- Une seule opération de compte => un seul acheteur, donc ce n'est pas une bouffe à plusieurs -->
                <span ng-if="(h.operations | filter:'accountoperation').length <= 1">
                    {{ h.timestamp | amCalendar }} : achat de
                    <span ng-repeat="o in h.operations | filter:'stockoperation'">
                        <span ng-if="$middle">, </span>
                        <span ng-if="$last && !$first"> et de </span>
                        <bars:food food="o.item" qty="(-1)*o.deltaqty"></bars:food>
                    </span>
                    par
                    <span ng-repeat="o in h.operations | filter:'accountoperation'">
                        <bars:account account="o.account"></bars:account>
                        <span class="label label-success">{{ o.deltamoney|currency }}</span>
                    </span>
                    <a title="Annuler cette transaction" ng-if="!h.canceled" ng-click="cancelTransaction(h)" class="label label-warning">Annuler</a>
                </span><br /><!-- Supprimer ce br dès que les bouffes à plusieurs sont implémentées dans Symfony -->

                <!-- Sinon, c'est une bouffe à plusieurs -->
                <span ng-if="(h.operations | filter:'accountoperation').length >= 1">
                    {{ h.timestamp | amCalendar }} :
                    <span ng-hide="displayDetail" ng-click="displayDetail = !displayDetail" ng-init="displayDetail = false" class="glyphicon glyphicon-expand"></span>
                    <span ng-show="displayDetail" ng-click="displayDetail = !displayDetail"  class="glyphicon glyphicon-collapse-down"></span>
                    bouffe à plusieurs entre {{ (h.operations | filter:'accountoperation').length }} participants <span class="label label-success">{{ (-1)*h.moneyflow|currency }}</span>
                    <a title="Annuler cette transaction" ng-if="!h.canceled" ng-click="cancelTransaction(h)" class="label label-warning">Annuler</a>
                    <span ng-show="displayDetail">
                        <ul>
                            <li>Participants :
                                <span ng-repeat="o in h.operations | filter:'accountoperation'">
                                    <span ng-if="$middle">, </span>
                                    <span ng-if="$last && !$first"> et </span>
                                    <bars:account account="o.account"></bars:account>
                                </span>
                            </li>
                            <li ng-repeat="o in h.operations | filter:'stockoperation'">
                                Achat de <bars:food food="o.item" qty="(-1)*o.deltaqty"></bars:food>
                                <span class="label label-success">{{ o.deltaqty * o.item.price|currency }}</span>
                            </li>
                        </ul>
                    </span>
                </span>
            </span>
        </ng:switch>
    </li>
</ul>
